# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase Hosting on merge
on:
  push:
    branches:
      - main
jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    env:
      VITE_DATA_API_BASE_URL: ${{ vars.VITE_DATA_API_BASE_URL }}
      VITE_API_BASE_URL: ${{ vars.VITE_API_BASE_URL }}
      VITE_FIREBASE_API_KEY: ${{ vars.VITE_FIREBASE_API_KEY }}
      VITE_FIREBASE_AUTH_DOMAIN: ${{ vars.VITE_FIREBASE_AUTH_DOMAIN }}
      VITE_FIREBASE_PROJECT_ID: ${{ vars.VITE_FIREBASE_PROJECT_ID }}
      VITE_FIREBASE_STORAGE_BUCKET: ${{ vars.VITE_FIREBASE_STORAGE_BUCKET }}
      VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ vars.VITE_FIREBASE_MESSAGING_SENDER_ID }}
      VITE_FIREBASE_APP_ID: ${{ vars.VITE_FIREBASE_APP_ID }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
          cache-dependency-path: code/package-lock.json
      - name: Validate frontend deployment configuration
        run: |
          if [[ -z "${VITE_DATA_API_BASE_URL}" ]]; then
            echo "VITE_DATA_API_BASE_URL must be configured via GitHub Actions variables before deploying." >&2
            exit 1
          fi
          if [[ -z "${VITE_API_BASE_URL}" ]]; then
            echo "VITE_API_BASE_URL must be configured via GitHub Actions variables before deploying." >&2
            exit 1
          fi
        env:
          VITE_DATA_API_BASE_URL: ${{ env.VITE_DATA_API_BASE_URL }}
          VITE_API_BASE_URL: ${{ env.VITE_API_BASE_URL }}
      - name: Install dependencies
        run: npm ci
        working-directory: code
      - name: Build
        run: npm run build
        working-directory: code
      - name: Install function dependencies
        run: npm ci
        working-directory: functions
      - name: Deploy share metadata function
        env:
          FIREBASE_SERVICE_ACCOUNT_CREATIVE_ATLAS: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_CREATIVE_ATLAS }}
          GOOGLE_APPLICATION_CREDENTIALS: ${{ runner.temp }}/firebase-service-account.json
          FIREBASE_DEPLOY_AGENT: github-actions
        run: |
          printf '%s' "${FIREBASE_SERVICE_ACCOUNT_CREATIVE_ATLAS}" > "${GOOGLE_APPLICATION_CREDENTIALS}"
          cd "${GITHUB_WORKSPACE}"
          npx --yes firebase-tools@14.25.0 deploy --only functions:shareMetadata --project creative-atlas --non-interactive --force
      - name: Deploy hosting
        env:
          FIREBASE_SERVICE_ACCOUNT_CREATIVE_ATLAS: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_CREATIVE_ATLAS }}
          GOOGLE_APPLICATION_CREDENTIALS: ${{ runner.temp }}/firebase-service-account.json
          FIREBASE_DEPLOY_AGENT: github-actions
        run: |
          printf '%s' "${FIREBASE_SERVICE_ACCOUNT_CREATIVE_ATLAS}" > "${GOOGLE_APPLICATION_CREDENTIALS}"
          npx firebase-tools@14.25.0 deploy --only hosting --project creative-atlas --non-interactive --force
  deploy_api:
    name: Deploy API to App Engine
    needs: build_and_deploy
    runs-on: ubuntu-latest
    env:
      GCP_APP_ENGINE_SERVICE_ACCOUNT: ${{ secrets.GCP_APP_ENGINE_SERVICE_ACCOUNT }}
      FIREBASE_SERVICE_ACCOUNT_CREATIVE_ATLAS: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_CREATIVE_ATLAS }}
      GEMINI_API_KEY: ${{ secrets.VITE_API_KEY || vars.VITE_API_KEY }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
          cache-dependency-path: server/package-lock.json
      - name: Validate Gemini credentials
        run: |
          if [[ -z "${GEMINI_API_KEY}" ]]; then
            echo "GEMINI_API_KEY must be configured via GitHub secrets or variables before deploying." >&2
            exit 1
          fi
      - name: Install dependencies
        run: npm ci
        working-directory: server
      - name: Build API
        run: npm run build
        working-directory: server
      - name: Resolve App Engine credentials
        id: resolve-credentials
        run: |
          if [[ -n "${GCP_APP_ENGINE_SERVICE_ACCOUNT}" ]]; then
            CREDENTIALS="${GCP_APP_ENGINE_SERVICE_ACCOUNT}"
          elif [[ -n "${FIREBASE_SERVICE_ACCOUNT_CREATIVE_ATLAS}" ]]; then
            echo "No dedicated App Engine service account secret configured; falling back to the Firebase service account." >&2
            CREDENTIALS="${FIREBASE_SERVICE_ACCOUNT_CREATIVE_ATLAS}"
          else
            echo "Neither GCP_APP_ENGINE_SERVICE_ACCOUNT nor FIREBASE_SERVICE_ACCOUNT_CREATIVE_ATLAS secrets are available for authentication." >&2
            exit 1
          fi

          {
            printf 'credentials_json<<EOF\n'
            printf '%s\n' "${CREDENTIALS}"
            printf 'EOF\n'
          } >> "${GITHUB_OUTPUT}"
        env:
          GCP_APP_ENGINE_SERVICE_ACCOUNT: ${{ secrets.GCP_APP_ENGINE_SERVICE_ACCOUNT }}
          FIREBASE_SERVICE_ACCOUNT_CREATIVE_ATLAS: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_CREATIVE_ATLAS }}
          CA_GITHUB_CLIENT_SECRET: ${{ secrets.CA_GITHUB_CLIENT_SECRET }}
          APP_BASE_URL: ${{ secrets.APP_BASE_URL }}      
          CA_GITHUB_CLIENT_ID: ${{ secrets.CA_GITHUB_CLIENT_ID }}
          GCP_PROJECT_ID: creative-atlas      
      - id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ steps.resolve-credentials.outputs.credentials_json }}
      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}
      - name: Inject secrets into app.yaml
        run: |
          python - <<'PY'
          import os
          import pathlib
          import re

          replacements = {
              "CA_GITHUB_CLIENT_ID": os.environ["CA_GITHUB_CLIENT_ID"],
              "CA_GITHUB_CLIENT_SECRET": os.environ["CA_GITHUB_CLIENT_SECRET"],
              "APP_BASE_URL": os.environ["APP_BASE_URL"],
              "GEMINI_API_KEY": os.environ["GEMINI_API_KEY"],
          }

          app_yaml = pathlib.Path("app.yaml")
          contents = app_yaml.read_text()

          for key, value in replacements.items():
              pattern = rf"^(\s*{key}:\s*).*$"
              contents = re.sub(pattern, lambda match: f"{match.group(1)}{value}", contents, flags=re.MULTILINE)

          app_yaml.write_text(contents)
          PY
        working-directory: server
        env:
          CA_GITHUB_CLIENT_ID: ${{ secrets.CA_GITHUB_CLIENT_ID }}
          CA_GITHUB_CLIENT_SECRET: ${{ secrets.CA_GITHUB_CLIENT_SECRET }}
          APP_BASE_URL: ${{ secrets.APP_BASE_URL }}
          GEMINI_API_KEY: ${{ env.GEMINI_API_KEY }}
      - name: Deploy to App Engine
        run: gcloud app deploy app.yaml --quiet
        working-directory: server
      - name: Prune old App Engine versions
        run: |
          gcloud app versions list --service="default" --sort-by="~VERSION.CREATE_TIME" --format="value(version.id,traffic_split)" \
            | awk '$2 == "0" || $2 == "0.00"' \
            | tail -n +6 \
            | cut -f1 \
            | xargs -r gcloud app versions delete --service="default" --quiet
